<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>AsuAlerta ‚Äì Panel intendente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tabler CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/css/tabler.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/css/tabler-flags.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/css/tabler-payments.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/css/tabler-vendors.min.css" rel="stylesheet" />

  <link rel="icon" type="image/x-icon" href="https://codigocenter.com/logo/asu1.png">

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    .category-dot{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px;}
    .foto-thumb{width:40px;height:40px;object-fit:cover;border-radius:4px;margin-right:4px;cursor:pointer;border:1px solid rgba(0,0,0,0.06);}
    .stat-label{font-size:0.8rem;text-transform:uppercase;letter-spacing:.04em;color:rgba(0,0,0,.6);}
    [data-bs-theme="dark"] .stat-label{color:rgba(255,255,255,.6);}
    .stat-number{font-size:1.7rem;font-weight:600;}
    .stat-caption{font-size:0.8rem;color:rgba(0,0,0,.55);}
    [data-bs-theme="dark"] .stat-caption{color:rgba(255,255,255,.55);}
    .badge-pill{border-radius:999px;}
    .timeline{border-left:2px solid rgba(0,0,0,0.1);padding-left:16px;margin-left:4px;}
    .timeline-item{position:relative;margin-bottom:18px;}
    .timeline-point{width:12px;height:12px;border-radius:50%;position:absolute;left:-7px;top:4px;background:#206bc4;}
    .timeline-event{padding-left:4px;}
    #miniMapaDetalle{width:100%;height:200px;border-radius:8px;border:1px solid rgba(0,0,0,.1);overflow:hidden;}
    .acciones-fotos img{width:52px;height:52px;object-fit:cover;border-radius:6px;margin-right:4px;margin-top:4px;border:1px solid rgba(0,0,0,0.08);cursor:pointer;}
    .op-kpi-number{font-size:1.8rem;font-weight:700;line-height:1.1;}
    .op-kpi-label{font-size:0.78rem;letter-spacing:.04em;color:rgba(0,0,0,.6);}

    /* Fix para Leaflet dentro de Tabler */
    .leaflet-container{z-index:1;}
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{
      background-color:rgba(0,0,0,0.25)!important;
      color:white!important;
    }
  </style>
</head>

<body>
  <div class="page">
    
    <!-- NAVBAR -->
    <header class="navbar navbar-expand-md navbar-light d-print-none">
      <div class="container-xl">

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
          <span class="navbar-toggler-icon"></span>
        </button>

        <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
          <span class="navbar-brand-text">AsuAlerta ‚Äì Intendente</span>
        </h1>

        <div class="navbar-nav flex-row order-md-last">

          <button class="nav-link px-3" id="themeToggle" type="button" title="Cambiar tema">üåô</button>

          <button id="btnFullscreen" class="btn btn-outline-secondary btn-icon" title="Pantalla completa">
            <i class="ti ti-maximize"></i>
          </button>

          <div class="nav-item dropdown ms-2">
            <a class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" href="#">
              <span class="avatar avatar-sm">IN</span>
              <div class="d-none d-xl-block ps-2">
                <div id="intNombreLabel">Intendente</div>
                <div class="mt-1 small text-muted" id="intDeptoLabel">Vista global</div>
              </div>
            </a>

            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
              <a id="btnLogout" href="javascript:void(0)" class="dropdown-item">Cerrar sesi√≥n</a>
            </div>
          </div>

        </div>

        <div class="collapse navbar-collapse" id="navbar-menu"></div>
      </div>
    </header>

    <!-- CONTENIDO -->
    <div class="page-wrapper">
      <div class="page-body">
        <div class="container-xl">

          <div class="page-header d-print-none">
            <div class="row align-items-center">
              <div class="col">
                <h2 class="page-title">Panel de intendente municipal</h2>
                <div class="text-muted mt-1">
                  Vista global de reportes ciudadanos y desempe√±o municipal.<br>
                  Por defecto se muestran solo los √∫ltimos 30 d√≠as.
                </div>

                <!-- SELECTOR 7 / 30 / GLOBAL -->
                <div class="alert alert-info mt-2 mb-1 py-2">
                  <div class="row mb-3">
                    <div class="col-auto">
                      <div class="btn-group" id="selectorTiempo">
                        <button class="btn btn-outline-primary active" data-dia="30">30 d√≠as</button>
                        <button class="btn btn-outline-primary" data-dia="7">7 d√≠as</button>
                        <button class="btn btn-outline-primary" data-dia="global">Global</button>
                      </div>
                    </div>
                  </div>

                  <b>Modo actual:</b> √∫ltimos 30 d√≠as ¬∑
                  <span class="small text-muted">Use los botones para ver hist√≥rico completo.</span>
                </div>
              </div>

              <!-- BOTONES HIST√ìRICOS -->
              <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                  <button id="btnCsv30" class="btn btn-outline-secondary">‚¨áÔ∏è CSV (30 d√≠as)</button>

                  <div class="btn-group">
                    <button id="btnVerHistorico" class="btn btn-primary">Ver hist√≥rico completo</button>
                    <button id="btnCsvHistorico" class="btn btn-outline-success">‚¨áÔ∏è CSV hist√≥rico</button>
                    <button id="btnMapaHistorico" class="btn btn-secondary">Mapa hist√≥rico</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- =============================== -->
          <!-- üî• NUEVOS KPIs DE EQUIPOS -->
          <!-- =============================== -->

          <div class="row row-deck row-cards mb-4">

            <!-- Mejor operador m√≥vil -->
            <div class="col-md-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="op-kpi-label">Mejor operador m√≥vil</div>
                <div class="op-kpi-number" id="kpi_top_movil">-</div>
                <div class="text-muted small" id="kpi_top_movil_det">-</div>
              </div></div>
            </div>

            <!-- M√°s acciones m√≥viles -->
            <div class="col-md-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="op-kpi-label">Acciones m√≥viles (TOP)</div>
                <div class="op-kpi-number" id="kpi_acciones_movil">-</div>
                <div class="text-muted small" id="kpi_acciones_movil_det">-</div>
              </div></div>
            </div>

            <!-- M√°s reportes resueltos -->
            <div class="col-md-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="op-kpi-label">M√°s reportes resueltos</div>
                <div class="op-kpi-number" id="kpi_resuelve_mas">-</div>
                <div class="text-muted small" id="kpi_resuelve_mas_det">-</div>
              </div></div>
            </div>

            <!-- M√°s r√°pido -->
            <div class="col-md-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="op-kpi-label">M√°s r√°pido (promedio)</div>
                <div class="op-kpi-number" id="kpi_mas_rapido">-</div>
                <div class="text-muted small" id="kpi_mas_rapido_det">-</div>
              </div></div>
            </div>

          </div>

          <!-- =============================== -->
          <!-- EQUIPO MUNICIPAL M√ÅS PRODUCTIVO -->
          <!-- =============================== -->
          <div class="row row-cards mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-status-top bg-blue"></div>
                <div class="card-header">
                  <h3 class="card-title">Equipo municipal m√°s productivo (√∫ltimos 30 d√≠as)</h3>
                </div>
                <div class="card-body">
                  <div id="kpi_equipo_productivo" class="fw-bold fs-3">-</div>
                  <div class="text-muted small" id="kpi_equipo_productivo_det">-</div>
                </div>
              </div>
            </div>
          </div>

          <!-- =============================== -->
          <!-- KPIs GLOBALES HIST√ìRICOS -->
          <!-- =============================== -->
          <div class="row row-deck row-cards mb-3">

            <div class="col-sm-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="stat-label">Total reportes</div>
                <div class="stat-number" id="stat_total_global">0</div>
                <div class="stat-caption">Hist√≥rico completo.</div>
              </div></div>
            </div>

            <div class="col-sm-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="stat-label">Pendientes</div>
                <div class="stat-number text-warning" id="stat_pendientes_global">0</div>
                <div class="stat-caption">En espera de soluci√≥n.</div>
              </div></div>
            </div>

            <div class="col-sm-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="stat-label">Solucionados</div>
                <div class="stat-number text-success" id="stat_solucionados_global">0</div>
                <div class="stat-caption">Casos resueltos.</div>
              </div></div>
            </div>

            <div class="col-sm-6 col-lg-3">
              <div class="card"><div class="card-body">
                <div class="stat-label">Tiempo promedio</div>
                <div class="stat-number" id="stat_tiempo_global">-</div>
                <div class="stat-caption">Horas promedio de resoluci√≥n.</div>
              </div></div>
            </div>

            <!-- ESTE BLOQUE ESTABA SUELTO ‚Äî YA EST√Å REPARADO -->
            <div class="col-sm-6 col-lg-3 mt-3">
              <div class="card"><div class="card-body">
                <div class="stat-label">Eficiencia global</div>
                <div class="stat-number" id="stat_eficiencia_global">-</div>
                <div class="stat-caption">% solucionados del total hist√≥rico.</div>
              </div></div>
            </div>

          </div>
          <!-- =============================== -->
          <!-- KPIS 30 D√çAS ORIGINALES         -->
          <!-- =============================== -->
          <div class="row row-deck row-cards mb-4">

            <div class="col-sm-6 col-lg-4">
              <div class="card">
                <div class="card-body">
                  <div class="stat-label">Reportes √∫ltimos 30 d√≠as</div>
                  <div class="stat-number" id="stat_total_30">0</div>
                  <div class="stat-caption">Carga ciudadana reciente.</div>
                </div>
              </div>
            </div>

            <div class="col-sm-6 col-lg-4">
              <div class="card">
                <div class="card-body">
                  <div class="stat-label">Solucionados √∫ltimos 30 d√≠as</div>
                  <div class="stat-number text-success" id="stat_sol_30">0</div>
                  <div class="stat-caption">Casos cerrados en ese per√≠odo.</div>
                </div>
              </div>
            </div>

            <div class="col-sm-6 col-lg-4">
              <div class="card">
                <div class="card-body">
                  <div class="stat-label">Pendientes &gt; 48h (30 d√≠as)</div>
                  <div class="stat-number text-danger" id="stat_atrasados_30">0</div>
                  <div class="stat-caption">Casos cr√≠ticos a priorizar.</div>
                </div>
              </div>
            </div>

          </div>
            <!-- =============================== -->
<!-- üî• KPIS AVANZADOS ‚Äì DASHBOARD   -->
<!-- =============================== -->
<div id="kpiAvanzadosContainer" class="mb-4">
  <!-- panel-intendente-advanced.js va a renderizar aqu√≠ -->
</div>

          <!-- =============================== -->
          <!-- GR√ÅFICOS 30 D√çAS               -->
          <!-- =============================== -->
          <div class="row row-deck row-cards mb-4">
            
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Reportes por categor√≠a (30 d√≠as)</div>
                </div>
                <div class="card-body">
                  <canvas id="chartCat30" height="140"></canvas>
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Reportes por departamento (30 d√≠as)</div>
                </div>
                <div class="card-body">
                  <canvas id="chartDepto30" height="140"></canvas>
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Pendientes vs solucionados (30 d√≠as)</div>
                </div>
                <div class="card-body">
                  <canvas id="chartEstado30" height="140"></canvas>
                </div>
              </div>
            </div>

          </div>

          <!-- =============================== -->
          <!-- MAPA 30 D√çAS                    -->
          <!-- =============================== -->
          <div class="card mt-4">
            <div class="card-header">
              <div class="card-title">Mapa √∫ltimos 30 d√≠as (cluster por categor√≠a)</div>
            </div>
            <div class="card-body p-0">
              <div id="map30" style="height:400px;width:100%;"></div>
            </div>
          </div>

          <!-- ================================ -->
          <!-- TABLA DE REPORTES 30 D√çAS        -->
          <!-- ================================ -->
          <div class="card mt-4">
            <div class="card-header">
              <div class="card-title">
                Reportes √∫ltimos 30 d√≠as
                <span class="text-muted small ms-2">(Atajos: R refresca, F buscador)</span>
              </div>
              <div class="card-actions">
                <button id="btnRefrescar" class="btn btn-icon" type="button" title="Refrescar (R)">‚ü≥</button>
              </div>
            </div>

            <div class="card-body border-bottom py-3">

              <div class="row g-2">

                <div class="col-md-3">
                  <div class="form-label">Buscar</div>
                  <input type="text" class="form-control" id="buscar" placeholder="Detalle, barrio o ciudadano..." />
                </div>

                <div class="col-md-3">
                  <div class="form-label">Estado</div>
                  <select class="form-select" id="filtroEstado">
                    <option value="">Todos</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="solucionado">Solucionado</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <div class="form-label">Categor√≠a</div>
                  <select class="form-select" id="filtroCategoria">
                    <option value="">Todas</option>
                    <option value="bache">Bache</option>
                    <option value="basural">Basural</option>
                    <option value="arbol_caido">√Årbol ca√≠do</option>
                    <option value="cano_roto">Ca√±o roto</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <div class="form-label">Departamento</div>
                  <select class="form-select" id="filtroDepto">
                    <option value="">Todos</option>
                  </select>
                </div>

                <div class="col-md-3 mt-2">
                  <div class="form-label">Fecha (desde)</div>
                  <input type="date" class="form-control" id="fchDesde">
                </div>

                <div class="col-md-3 mt-2">
                  <div class="form-label">Fecha (hasta)</div>
                  <input type="date" class="form-control" id="fchHasta">
                </div>

              </div>

            </div>

            <!-- TABLA -->
            <div class="table-responsive">
              <table class="table table-vcenter card-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Departamento</th>
                    <th>Categor√≠a</th>
                    <th>Barrio</th>
                    <th>Detalle</th>
                    <th>Ciudadano</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>

                <tbody id="tablaReportesInt">
                  <tr><td colspan="9" class="text-center py-4">Cargando...</td></tr>
                </tbody>

              </table>
            </div>

            <div id="paginacionTabla" class="card-footer d-flex align-items-center"></div>

          </div> <!-- cierre card tabla -->
        </div> <!-- /container-xl -->
      </div> <!-- /page-body -->
    </div> <!-- /page-wrapper -->
  </div> <!-- /page -->

  <!-- ========================= -->
  <!-- OFFCANVAS DETALLE REPORTE -->
  <!-- ========================= -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="detalleReportePanel">
    <div class="offcanvas-header">
      <div>
        <h3 class="offcanvas-title" id="detalleTitulo">Detalle de reporte</h3>
        <div class="text-muted small" id="detalleSubtitulo"></div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>

    <div class="offcanvas-body">

      <div class="mb-3">
        <span id="detalleBadgeEstado" class="badge badge-pill bg-warning me-2">Pendiente</span>
        <span class="badge badge-pill bg-secondary" id="detalleCategoriaChip">CATEGOR√çA</span>
        <span class="badge badge-pill bg-info ms-2" id="detalleDeptoChip">DEPTO</span>
      </div>

      <div class="mb-3">
        <div class="text-muted text-uppercase small mb-1">Datos del ciudadano</div>
        <div id="detalleCiudadanoNombre" class="fw-semibold">-</div>
        <div id="detalleCiudadanoCelular" class="text-muted small">-</div>
      </div>

      <div class="mb-3">
        <div class="text-muted text-uppercase small mb-1">Descripci√≥n del problema</div>
        <div id="detalleTextoReporte">-</div>
      </div>

      <div class="mb-3">
        <div class="text-muted text-uppercase small mb-1">Fechas del proceso</div>
        <div id="detalleFechas"></div>
      </div>

      <div class="mb-3">
        <div class="text-muted text-uppercase small mb-1">Resumen categor√≠a / barrio (30 d√≠as)</div>
        <div id="detalleMiniDashboard" class="small"></div>
      </div>

      <div class="mb-3">
        <div class="text-muted text-uppercase small mb-1">Ubicaci√≥n en mapa</div>
        <div id="miniMapaDetalle"></div>

        <div class="mt-2 d-flex justify-content-between">
          <div id="alertaDuplicados" class="alert alert-warning d-none mb-0 me-2 py-1 px-2 flex-grow-1">
            ‚ö†Ô∏è Hay reportes cercanos a esta ubicaci√≥n.
            <div id="listaDuplicados" class="small mt-1"></div>
          </div>

          <button id="btnAbrirEnMapa" class="btn btn-outline-primary btn-sm ms-2">
            üó∫Ô∏è Abrir en mapa grande
          </button>
        </div>
      </div>

      <div class="mb-3">
        <div class="text-muted text-uppercase small mb-1">Fotos aportadas por el ciudadano</div>
        <div id="detalleFotosCiudadano" class="d-flex flex-wrap"></div>
      </div>

      <hr class="my-3"/>

      <div class="mb-2 d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted text-uppercase small mb-1">
            Acciones realizadas por operadores m√≥viles
          </div>
          <div class="small text-muted">
            Intervenciones municipales registradas desde el campo.
          </div>
        </div>
      </div>

      <div id="accionesListado"></div>

    </div>
  </div>

  <!-- ========================= -->
  <!-- JS B√ÅSICO DE LA P√ÅGINA    -->
  <!-- ========================= -->
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta19/dist/js/tabler.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- ========================= -->
  <!-- L√ìGICA DEL PANEL          -->
  <!-- ========================= -->
  <script type="module" src="panel-intendente.js"></script>
  <script type="module" src="panel-intendente-advanced.js"></script>

</body>
</html>

